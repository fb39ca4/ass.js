<!DOCTYPE html> 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>ass.js demo</title>
<script src="interpolating.js"></script>
<script src="ass.js"></script>
<script src="htmlrenderer.js"></script>

<link href="video-js.css" rel="stylesheet">
<script src="video.js"></script>

<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Rajdhani:500' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cabin+Condensed:700' rel='stylesheet' type='text/css'>
<link href='font/webfonts.css' rel='stylesheet' type='text/css'>

<script id="j">

var video_player;
var subtitle_div;
var subtitle_fileinput;
var video_fileinput;
var video_div;
var videoJsObj;
var assRenderer = new AssRenderer();

var hideFileInputTimeout;

window.onload = function(){
  if (navigator.userAgent.toLowerCase().indexOf("webkit") != -1) window.alert("ass.js is only compatible with Firefox and IE11");
  else if (navigator.userAgent.toLowerCase().indexOf("msie 10") != -1) window.alert("ass.js is only compatible with Firefox and IE11");
  video_player = document.getElementById('video_player');
  subtitle_div = document.getElementById('subtitle_div');
  subtitle_fileinput = document.getElementById('subtitle_fileinput');
  video_fileinput = document.getElementById('video_fileinput');
  top_bar = document.getElementById('top_bar');
  video_div = document.getElementById('video_div');
  videoJsObj = videojs("video_player", {}, null);
	
	window.addEventListener("resize", function(){if (typeof(assRenderer) != "undefined") assRenderer.scaleSubtitleDiv();}, false)
  
  window.onmousemove = function() {
    top_bar.style.transform = "translate(0%, 0%)";
    clearTimeout(hideFileInputTimeout);
    hideFileInputTimeout = setTimeout(function(){top_bar.style.transform = "translate(0%, -100%)";}, 2000, false);
  };
  assRenderer.setSubtitleDiv(video_div.getElementsByClassName("vjs-text-track-display")[0]);
  assRenderer.setVideoElement(video_player);
  
  var urlParams = getUrlParams();
  if (!urlParams.vid) urlParams.vid = "AttackOnTitan_OP2.mp4";
  if (!urlParams.sub) urlParams.sub = "AttackOnTitan_OP2.ass";
  
  loadSubtitlesFromURL("test/" + urlParams.sub);
  loadVideoFromURL("test/" + urlParams.vid);
}

function loadVideoFromURL(url) {
  videoJsObj.src(url);
}

function loadSubtitlesFromURL(url) {
  var xhr = new XMLHttpRequest();
  xhr.overrideMimeType("text/plain; charset=utf-8");
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      loadAss(xhr.responseText);
    }
  }
  try {
    xhr.open("GET", url, true);
    xhr.send();
  }
  catch(err) {}
}

function loadVideoFile() {
  videoJsObj.src(window.URL.createObjectURL(video_fileinput.files[0]));
}

function loadSubtitleFile() {
  var fr = new FileReader();
  fr.onload = function(){loadAss(fr.result)};
  fr.readAsText(subtitle_fileinput.files[0]);
}
function loadAss(assString) {
  var assObj = Ass.fromString(assString);
  assRenderer.assData = assObj;
  assRenderer.generateHTML();
}

function changeVideo(btn) {
  console.log(this);
  loadVideoFromURL(btn.getAttribute("vid"));
  loadSubtitlesFromURL(btn.getAttribute("sub"));
}

function getUrlParams() {
  var raw = window.location.search.substring(1).split("&");
  var processed = {};
  for (var i = 0; i < raw.length; i++) {
    var name = raw[i].substring(0, raw[i].indexOf("="));
    var arg = raw[i].substring(raw[i].indexOf("=") + 1);
    if (name) processed[name] = arg;
  }
  return processed;
}

</script>

</head>

<body>
  <div id="body_wrapper">
    <div id="video_div">
      <video id="video_player" controls preload="auto" class="video-js vjs-default-skin vjs-big-play-centered video-wrapper" src=""></video> 
    </div>
      
    <div id="top_bar">
      <a href="index.html?vid=Henneko_OP.mp4&sub=Henneko_OP.ass">Henneko OP</a>
      <a href="index.html?vid=AttackOnTitan_OP2.mp4&sub=AttackOnTitan_OP2.ass">Attack on Titan OP 2</a>
      <a href="index.html?vid=RailgunS_OP1.mp4&sub=RailgunS_OP1.ass">Railgun S OP 1</a>
      <br>Subtitle: <input type="file" id="subtitle_fileinput" style="" onchange="loadSubtitleFile()">
      Video: <input type="file" id="video_fileinput" accept="*/*" onchange="loadVideoFile()">
    </div>
  </div>
  <style>
html, body {
  height: 100%;
  margin: 0;
}

#body_wrapper {
	background: black;
	color: white;
	min-height: 100%;
	overflow: hidden;
}

#video_div {
  background: black;
  position: absolute;
  top: 0; left: 0; bottom: 0; right: 0;
  height: 100%;
  width: 100%;
  margin: auto;
}

#video_player {
  background: black;
  height: 100% !important;
  width: 100% !important;
}

#subtitle_div {
  background: transparent;
  /*position: relative;
  top: -100%;
  height: 100%;*/
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  overflow: hidden;
}

#top_bar {
  position: absolute;
  top: 0px;
  width: 100%;
  text-align: center;
  background: rgba(0,0,0,0.5);
  transition: transform 1s;
  z-index: 9001;
}


</style>
</body>

